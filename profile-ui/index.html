<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Profile</title>
    <!-- Include your mission handling logic -->
    <script src="./js/missionHandler.js" defer></script>
    <script src="./js/common.js" defer></script>
    <script src="./js/location/locationHandler.js" defer></script>
    <script src="./js/breaking/newsHandler.js" defer></script>
    <script src="./js/actionbar/actionBarHandler.js" defer></script>
    <script src="./js/license/licenseHandler.js" defer></script>
    <script src="./js/attachment/attachmentHandler.js" defer></script>
    <script src="./js/management/managementHandler.js" defer></script>
    <script src="./js/banner/bannerHandler.js" defer></script>
    <script src="./js/socialMediaForm/socialMediaHandler.js" defer></script>
    <script src="./js/about/aboutHandler.js" defer></script>
    <script src="./js/services/serviceHandler.js" defer></script>
    <!-- Import Alpine.js -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/alpinejs@2.8.2/dist/alpine.min.js"
      defer
    ></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
      rel="stylesheet"
    />
    <script src="./js/missionCard.js" defer></script>
    <script src="./js/management/managementContainer.js" defer></script>
    <script src="./js/breaking/newsContainer.js" defer></script>
    <script src="./js/services/serviceContainer.js" defer></script>
    <script src="./js/location/locationContainer.js" defer></script>
    <script src="./js/location/locationEditContainer.js" defer></script>
    <script src="./js/attachment/attachmentContainer.js" defer></script>
    <script src="./js/license/licenseContainer.js" defer></script>
    <script src="./js/about/aboutContainer.js" defer></script>
    <script src="./js/entryPanel/entryContainer.js" defer></script>
    <script src="./js/actionbar/actionBarContainer.js" defer></script>
    <script src="./js/banner/bannerContainer.js" defer></script>
    <script src="./js/privacyButton/privacyButtonContainer.js" defer></script>
    <script src="./js/navigation/navigationContainer.js" defer></script>
    <script src="./js/breaking/editContainer.js" defer></script>
    <script
      src="./js/socialMediaForm/socialMediaPrivacyContainer.js"
      defer
    ></script>
    <script src="./js/product/productContainer.js" defer></script>
    <script
      src="./js/socialMediaForm/socialMediaFormContainer.js"
      defer
    ></script>
    <script src="./js/actionButton/actionButtonContainer.js" defer></script>
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <link rel="stylesheet" href="./styles/mission.css" />
    <link rel="stylesheet" href="./styles/management.css" />
    <link rel="stylesheet" href="./styles/breaking.css" />
    <link rel="stylesheet" href="./styles/services.css" />
    <link rel="stylesheet" href="./styles/location.css" />
    <link rel="stylesheet" href="./styles/attachment.css" />
    <link rel="stylesheet" href="./styles/license.css" />
    <link rel="stylesheet" href="./styles/about.css" />
    <link rel="stylesheet" href="./styles/entry.css" />
    <link rel="stylesheet" href="./styles/action.css" />
    <link rel="stylesheet" href="./styles/banner.css" />
    <link rel="stylesheet" href="./styles/privacyButton.css" />
    <link rel="stylesheet" href="./styles/navigation.css" />
    <link rel="stylesheet" href="./styles/actionButton.css" />
    <link rel="stylesheet" href="./styles/general.css" />
    <link rel="stylesheet" href="./styles/locationEdit.css" />
    <link rel="stylesheet" href="./styles/locationView.css" />
    <link rel="stylesheet" href="./styles/breakingEdit.css" />
    <link rel="stylesheet" href="./styles/product.css" />
    <link rel="stylesheet" href="./styles/socialMedia.css" />
    <style>
      .main-div {
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
      }
      .section-wrapper {
        margin-top: 50px;
      }
      /* Add a new style for the main content container */
      #content-container {
        display: none; /* Initially hidden */
        width: 100%;
      }
      /* Enhanced loader style */
      #loader {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }
      .spinner-border {
        width: 3rem;
        height: 3rem;
      }
    </style>
  </head>
  <body>
    <!-- Loader that will show initially -->
    <div id="loader">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>

    <!-- Main content container (initially hidden) -->
    <div id="content-container" class="main-div">
      <entry-section id="Full Page"></entry-section>
      <action-bar-section></action-bar-section>
      <banner-section></banner-section>
      <navigation-section></navigation-section>
      <about-section id="About" class="section-wrapper"></about-section>
      <mission-card missionData="missionData"></mission-card>
      <management-section id="Management"></management-section>
      <breaking-section id="News" class="isComponentView"></breaking-section>
      <breaking-edit id="News" class="isComponentEdit"></breaking-edit>
      <service-section id="Services"></service-section>
      <location-section
        id="Locations"
        class="isComponentView"
      ></location-section>
      <location-edit id="Locations" class="isComponentEdit"></location-edit>
      <product-section id="Menus"></product-section>
      <license-section></license-section>
      <attachment-section></attachment-section>
      <div
        id="toast-container"
        class="position-fixed top-0 end-0 p-3"
        style="z-index: 1050"
      ></div>
    </div>

    <script>
      function showToast(message, type = "success") {
        const toastId = "toast-" + Date.now();
        const toastHTML = `
      <div id="${toastId}" class="toast align-items-center text-bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
          <div class="toast-body">${message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      </div>
    `;
        const container = document.getElementById("toast-container");
        container.insertAdjacentHTML("beforeend", toastHTML);
        const toastElement = new bootstrap.Toast(
          document.getElementById(toastId)
        );
        toastElement.show();
      }

      function toggleSections(privacySettings) {
        // Check if we're in view mode (not edit or privacy)
        const activeBtn = document.querySelector(".action-button--active");
        const isViewMode = !activeBtn || 
                          (activeBtn.dataset.action !== "edit" && 
                           activeBtn.dataset.action !== "privacy");

        if (!isViewMode) {
            // If we're in edit or privacy mode, show all sections
            return;
        }

        const sectionsMapping = {
            mission_vision_values: ["mission-card"],
            management: ["management-section"],
            breaking_news: ["breaking-section"],
            services: ["service-section"],
            locations: ["location-section"],
            licenses_permissions: ["license-section"],
            attachments: ["attachment-section"],
        };

        Object.entries(sectionsMapping).forEach(([key, selectors]) => {
            selectors.forEach((selector) => {
                const sectionEl = document.querySelector(selector);
                if (sectionEl) {
                    sectionEl.style.display =
                        privacySettings[key] === false ? "flex" : "none";
                }
            });
        });
      }

      window.addEventListener("actionChange", (event) => {
        const { print } = event.detail;
        if (print) window.print();
      });

      window.addEventListener("actionChange", function(event) {
        const { isEdit, isPrivacy } = event.detail;
        // Only apply privacy settings in view mode (when neither editing nor in privacy mode)
        if (!isEdit && !isPrivacy) {
            fetchUserData(); // This will re-fetch and apply privacy settings
        } else {
            // Show all sections in edit or privacy mode
            const sections = document.querySelectorAll('.section-wrapper, mission-card, management-section, breaking-section, service-section, location-section, license-section, attachment-section');
            sections.forEach(section => {
                section.style.display = "flex";
            });
        }
      });

      document.addEventListener("DOMContentLoaded", function () {
        // Show loader and hide content initially
        document.getElementById('loader').style.display = 'flex';
        document.getElementById('content-container').style.display = 'none';
        
        const componentEdits = document.querySelectorAll(".isComponentEdit");
        const componentView = document.querySelectorAll(".isComponentView");
        componentEdits.forEach((el) => (el.style.display = "none"));
        componentView.forEach((el) => (el.style.display = "flex"));

        window.addEventListener("actionChange", function (event) {
          const { isEdit } = event.detail;
          if (isEdit) {
            componentEdits.forEach((el) => (el.style.display = "flex"));
            componentView.forEach((el) => (el.style.display = "none"));
          } else {
            componentEdits.forEach((el) => (el.style.display = "none"));
            componentView.forEach((el) => (el.style.display = "flex"));
          }
        });

        function fetchUserData() {
          const token =
            "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJhdWQiOiIxIiwianRpIjoiYWJjMWVkODBhMjIyMjVmYjEzZjRkN2ZmOTE4ZWVlNmRmMWQ1MDBmNTY0YWY0Mzk4OTliZTM5MzMzOTBjOTRjYzZhOTg3Yzc4YmU5M2E2NWMiLCJpYXQiOjE3NDM4MjYyMzYuOTMyNDIzLCJuYmYiOjE3NDM4MjYyMzYuOTMyNDI2LCJleHAiOjE3NzUzNjIyMzYuOTIzNzA2LCJzdWIiOiIxIiwic2NvcGVzIjpbXX0.6bSmzdbWjxexzlBPi86fD7leym9SQ5Ho63E1tIWc1lwWakf0TXp-gFf4efP2R3qmFb598PzBHuxHC6RBYL_xqeAm1wai94b6nf5u61pPNjFMOq3FKQ6kFcRsr4EPwVXYqgwk6mgSXHxCxnpFWi1FwZa4jBIyqKL2t3oWK8zw9WhBNjOtIZp6eQcfGJUyYblbkWBZLfhT66TFTwMUE2KxP1XUwIl0P5CRP7eEwRDoZmZQKmF2KgKHkeXLjXvhuDcbbgIhEkAFyo5TQfWy20CXUMOw0XNItQQux0_SNiyUTt-4_rOPZW0dSiXTtrQmxIuc2i_kk3bNJxLflP-XpYWW-PsEayXnRPrf0iFLmj0QP_UR-3HcuwGjZmQLsKGUFpFFnO06MMPxgKzo2WYL7A3NSSvtj1-1w-fM06e34bHkrpxFv5QVHgUm0NO-qTeSMZeCnn6tY4XJ7I1A5wUKVQ1og1oBjoLxN9m7kolgyfbvpNc57_OLBNzXeb_F8ljeBw5ZDb7sboiZYIlzJPchgg_1Xs9Q7pegM3sMsjYn1sGJVtFR940h9CqJgfEFLe8vQAUuhzb6wmxreLJ-0nIfz0rUWylS25NJY82N4fGTs6zIbgCVSkWDhgLIyq6N665SJbFOpVnQGAzkbpcWqzeMk9Y1Nu6VM_2IH7yYl2ReJ07QbP8";

          // DOM element selectors
          const entryPanel = document.querySelector("entry-section");
          const missionCard = document.querySelector("mission-card");
          const locationEditCard = document.querySelector("location-edit");
          const locationViewCard = document.querySelector("location-section");
          const bannerSection = document.querySelector("banner-section");
          const aboutSection = document.querySelector("about-section");
          const serviceSection = document.querySelector("service-section");
          const BreakingEditCard = document.querySelector("breaking-edit");
          const BreakingViewCard = document.querySelector("breaking-section");
          const licenseCard = document.querySelector("license-section");
          const attachmentCard = document.querySelector("attachment-section");
          const managementCard = document.querySelector("management-section");
          const productCard = document.querySelector("product-section");

          // Prepare both fetch calls
          const userDataPromise = fetch(
            "https://api.servehere.com/api/auth/user",
            {
              method: "GET",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
            }
          ).then((response) => {
            if (!response.ok) {
              throw new Error("User request failed: " + response.statusText);
            }
            return response.json();
          });

          const businessDataPromise = fetch(
            "https://api.servehere.com/api/business/1",
            {
              method: "GET",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
            }
          ).then((response) => {
            if (!response.ok) {
              throw new Error(
                "Business request failed: " + response.statusText
              );
            }
            return response.json();
          });

          // Execute both requests concurrently
          Promise.all([userDataPromise, businessDataPromise])
            .then(([userData, businessData]) => {
              const missionData = userData.data.user_mission || {};
              const locationData = userData.data.userLocations || {};
              const breakingData = userData.data.breaking_news || {};
              const licenseData = userData.data.user_licenses_permissions || [];
              const attachmentData = userData.data.user_attachments || [];
              const managementData = userData.data.managments || [];
              const serviceData = userData.data.services || [];
              const productData = userData.data.categories || [];
              const productMenusData =
                userData.data.categories.flatMap(
                  (category) => category.menus
                ) || [];
              const privacySettings = userData.data.settings;

              entryPanel.dispatchEvent(
                new CustomEvent("entryDataReceived", {
                  detail: { ...userData.data, business: businessData.data },
                })
              );

              missionCard.dispatchEvent(
                new CustomEvent("missionDataReceived", {
                  detail: { missionData, settings: privacySettings },
                })
              );
              locationViewCard.dispatchEvent(
                new CustomEvent("locationDataReceived", {
                  detail: {
                    locations: locationData,
                    settings: privacySettings,
                  },
                })
              );
              locationEditCard.dispatchEvent(
                new CustomEvent("locationDataReceived", {
                  detail: locationData,
                })
              );

              bannerSection.dispatchEvent(
                new CustomEvent("bannerDataReceived", {
                  detail: { ...userData.data, business: businessData.data },
                })
              );

              aboutSection.dispatchEvent(
                new CustomEvent("aboutDataReceived", {
                  detail: { ...userData.data, business: businessData.data },
                })
              );
              BreakingEditCard.dispatchEvent(
                new CustomEvent("breakingDataReceived", {
                  detail: breakingData,
                })
              );
              BreakingViewCard.dispatchEvent(
                new CustomEvent("breakingDataReceived", {
                  detail: {
                    breakingNews: breakingData,
                    settings: privacySettings,
                  },
                })
              );
              licenseCard.dispatchEvent(
                new CustomEvent("licenseDataReceived", {
                  detail: { licenses: licenseData, settings: privacySettings },
                })
              );
              attachmentCard.dispatchEvent(
                new CustomEvent("attachmentDataReceived", {
                  detail: {
                    attachments: attachmentData,
                    settings: privacySettings,
                  },
                })
              );
              managementCard.dispatchEvent(
                new CustomEvent("managementDataReceived", {
                  detail: {
                    management: managementData,
                    settings: privacySettings,
                  },
                })
              );
              serviceSection.dispatchEvent(
                new CustomEvent("serviceDataReceived", {
                  detail: { services: serviceData, settings: privacySettings },
                })
              );
              productCard.dispatchEvent(
                new CustomEvent("productDataReceived", {
                  detail: { products: productData, menus: productMenusData },
                })
              );
              toggleSections(privacySettings);
              
              // Hide loader and show content after data is loaded
              document.getElementById('loader').style.display = 'none';
              document.getElementById('content-container').style.display = 'flex';
            })
            .catch((error) => {
              console.error("Error fetching data:", error);
              // Hide loader even if there's an error
              document.getElementById('loader').style.display = 'none';
              document.getElementById('content-container').style.display = 'flex';
              showToast("Failed to load data. Please try again.", "danger");
            });
        }

        fetchUserData();
        document.addEventListener("profileDataSaved", async () => {
          console.log("User saved successfully, re-fetching user data...");
          // Show loader during refresh
          document.getElementById('loader').style.display = 'flex';
          document.getElementById('content-container').style.display = 'none';
          
          await fetchUserData();
          
          const activeBtn = document.querySelector(".action-button--active");
          console.log(activeBtn, "activeBtn");
          if (activeBtn) {
            const action = activeBtn.dataset.action;
            const isEdit = action === "edit";
            const isPrivacy = action === "privacy";
            console.log(isEdit, "isEdit", isPrivacy, "isPrivacy");

            window.dispatchEvent(
              new CustomEvent("actionChange", { detail: { isEdit, isPrivacy } })
            );
          }
        });
      });
    </script>
  </body>
</html>